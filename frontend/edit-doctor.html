<script src="js/core.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="css/styles.css">
<script>
    async function isAllowedThisPage() {
        const user = await getUserProfile();
        if (user.role === "admin") {
            return true;
        }
        const queryId = new URLSearchParams(window.location.search).get('id');
        return queryId === user.id;
    }

    isAllowedThisPage().then(isAllowed => {
        if (!isAllowed) {
            redirectTo('/profile');
        }
    });

</script>
<title> Welcome </title>
<nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
        <div class="hidden w-full md:block md:w-auto" id="navbar-default">
            <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
                <li>
                    <a id="dashboard-item"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Dashboard</a>
                </li>
                <li>
                    <a href="/profile"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Profile</a>
                </li>
                <li>
                    <a href="/"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Home</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<h2 id="header-title">edit doctor</h2>
<form id="doctor-form">
    <label for="email">Email</label>
    <input type="email" id="email" name="email" required>
    <br>
    <label for="firstName">First Name</label>
    <input type="text" id="firstName" name="firstName" required>
    <br>
    <label for="lastName">Last Name</label>
    <input type="text" id="lastName" name="lastName" required>
    <br>
    <label for="expertises">Expertises</label>
    <select id="expertises" name="expertises" multiple required><!-- will be filled by scripts --></select>
    <br>
    <label for="workstart">Work</label>
    <br>
    <label for="workstart">Start Time</label>
    <input type="time" id="workstart" name="time">
    <label for="workend">End Time</label>
    <input type="time" id="workend" name="time">
    <br>
    <button type="submit">save doctor</button>
    <button id="delete-doctor">delete doctor</button>
</form>

<script>

    (async () => {
        const user = await getUserProfile();
        switch (user.role) {
            case 'patient':
                document.getElementById('dashboard-item').href = '/patient-dashboard';
                break;
            case 'doctor':
                document.getElementById('dashboard-item').href = '/doctor-dashboard';
                break;
            case 'admin':
                document.getElementById('dashboard-item').href = '/admin-dashboard';
                break;
            default:
                document.getElementById('dashboard-item').href = '/profile';
        }
    })();
    function showNotFound() {
        // hide the form
        document.getElementById('doctor-form').style.display = 'none';
        document.getElementById("header-title").innerText = "doctor not found";
    }

    async function updateFormDatas(doctor) {
        document.getElementById('email').value = doctor.email;
        document.getElementById('firstName').value = doctor.firstName;
        document.getElementById('lastName').value = doctor.lastName;
        const [workStart, workEnd] = workPlan2workStartEnd(doctor.workPlan);
        document.getElementById('workstart').value = workStart;
        document.getElementById('workend').value = workEnd;
    }

    function initpage(doctor) {
        updateFormDatas(doctor);

        (async () => {
            const user = await getUserProfile();
            const queryId = new URLSearchParams(window.location.search).get('id');
            if (queryId === user.id) {
                document.getElementById('delete-doctor').style.display = 'none';
            }

            document.getElementById('delete-doctor').addEventListener('click', async (e) => {
               e.preventDefault();

                try {
                     await deleteUser(doctor.id);
                     redirectTo('/admin-dashboard');
                } catch (error) {
                     alert('Delete failed: ' + error.message);
                }
            });
        })();

        (async () => {
            const expertises = await getAllExpertises();
            const expertisesSelector = document.getElementById('expertises');
            expertises.forEach(expertise => {
                const option = document.createElement('option');
                option.value = expertise.name;
                option.textContent = expertise.name;
                if (doctor.expertises.includes(expertise.name)) {
                    option.selected = true;
                }
                expertisesSelector.appendChild(option);
            });
        })();

        document.getElementById('doctor-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formdata = getDoctorFormDatas()
            if (formdata === undefined)
                return;

            try {
                await updateUser(doctor.id, {
                    "email": formdata.email,
                    "firstName": formdata.firstName,
                    "lastName": formdata.lastName,
                    "expertises": formdata.expertises,
                    "workPlan": formdata.workPlan
                });
                redirectTo('/admin-dashboard');
            } catch (error) {
                alert('Appointment failed: ' + error.message);
            }
        });
    }


    const doctorId = new URLSearchParams(window.location.search).get('id');
    if (doctorId == null) {
        showNotFound()
    } else {
        getAllUsers().then(users => {
            const doctor = users.filter(user => user.id === doctorId)[0];
            if (doctor == null) {
                showNotFound()
            } else {
                initpage(doctor)
            }

        })
    }


</script>