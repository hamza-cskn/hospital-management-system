<script src="js/core.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="css/styles.css">
<script>
    checkIfUserIs('doctor').then(isDoctor => {
         if (!isDoctor) {
             redirectTo('/profile');
         }
    });
</script>
<title> Welcome </title>
<nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
        <div class="hidden w-full md:block md:w-auto" id="navbar-default">
            <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
                <li>
                    <a id="dashboard-item"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Dashboard</a>
                </li>
                <li>
                    <a href="/profile"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Profile</a>
                </li>
                <li>
                    <a href="/"
                       class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Home</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<h1>Doctor Dashboard</h1>

<div id="my-appointments">
    <h1>Appointment</h1>
    <div id="upcoming-appointments">
        <h2>Upcoming Appointment</h2>
        <div id="upcoming-appointments-container"></div>
    </div>
    <div id="past-appointments">
        <h2>Past Appointment</h2>
        <div id="past-appointments-container"></div>
    </div>
</div>

<script>

    (async () => {
        const user = await getUserProfile();
        switch (user.role) {
            case 'patient':
                document.getElementById('dashboard-item').href = '/patient-dashboard';
                break;
            case 'doctor':
                document.getElementById('dashboard-item').href = '/doctor-dashboard';
                break;
            case 'admin':
                document.getElementById('dashboard-item').href = '/admin-dashboard';
                break;
            default:
                document.getElementById('dashboard-item').href = '/profile';
        }
    })();
    (async () => {
        try {
            const appointments = await getAppointments();

            const upcomingContainer = document.querySelector('#upcoming-appointments-container');
            const pastContainer = document.querySelector('#past-appointments-container');

            for (const appointment of appointments) {
                const patient = await getUserById(appointment.patientId);
                if (patient == null) {
                    console.log('Patient not found for appointment:', appointment);
                    continue
                }
                const appointmentCard = document.createElement('div');
                appointmentCard.className = 'appointment-card';
                appointmentCard.innerHTML = `
                    <h5>${patient.firstName} ${patient.lastName}</h5>
                    <p>Status: ${appointment.status}</p>
                    <p>Note: ${appointment.notes}</p>
                    <p>Department: ${appointment.department}</p>
                    <p>Date: ${new Date(appointment.startTime).toLocaleString()}</p>
                    <p>Duration: ${Math.round((new Date(appointment.endTime) - new Date(appointment.startTime)) / 60000)} minutes</p>
                    ${appointment.status === 'pending' ? `<button id="cancel-button-${appointment.id}">Cancel</button>` : ''}
                    ${appointment.status === 'pending' ? `<button id="complete-button-${appointment.id}">Mark as done</button>` : ''}
                `;

                if (new Date(appointment.dateTime) > new Date()) {
                    upcomingContainer.appendChild(appointmentCard);
                } else {
                    pastContainer.appendChild(appointmentCard);
                }

                document.getElementById("cancel-button-"+appointment.id)?.addEventListener('click', async (event) => {
                    const appointmentId = event.target.id.substring("cancel-button-".length);
                    try {
                        await cancelAppointment(appointmentId);
                        location.reload();
                    } catch (error) {
                        alert('Failed to cancel appointment: ' + error.message);
                    }
                });

                document.getElementById("complete-button-"+appointment.id)?.addEventListener('click', async (event) => {
                    const appointmentId = event.target.id.substring("complete-button-".length);
                    try {
                        await doneAppointment(appointmentId);
                        location.reload();
                    } catch (error) {
                        alert('Failed to cancel appointment: ' + error.message);
                    }
                });

            }
        } catch (error) {
            console.error('Error fetching appointments:', error);
        }
    })();

</script>