<title>Patient Book Appointment</title>
<link rel="stylesheet" href="css/styles.css">
<script src="js/core.js"></script>
<script>
    checkIfUserIs('patient').then(isPatient => {
        if (!isPatient) {
            redirectTo('/profile');
        }
    });
</script>
<title> Welcome </title>
<nav>
    <a href="/admin-dashboard">admin dashboard</a>
    <a href="/doctor-dashboard">doctor dashboard</a>
    <a href="/patient-dashboard">patient dashboard</a>
    <a href="/profile">profile</a>
    <a href="/">home</a>
</nav>

<h2>Create appointment</h2>
<form id="appointment-form">
    <label for="doctor">Doctor</label>
    <select id="doctor" name="doctor"><!-- will be filled by scripts --></select>
    <label for="department">Department</label>
    <select id="department" name="department"><!-- will be filled by scripts --></select>
    <br>
    <label for="date">Date</label>
    <input type="date" id="date" name="date">
    <br>
    <label for="time">Time</label>
    <input type="time" id="time" name="time">
    <br>
    <label for="duration">Duration</label>
    <input type="number" id="duration" name="duration" min="1">
    <label for="duration">minutes</label>
    <br>
    <label for="note">Note</label>
    <br>
    <textarea id="note" name="note" style="max-width: 100%; max-height: 400px"></textarea>
    <br>
    <button type="submit">Book appointment</button>
</form>

<script>
    (async () => {
        const doctors = (await getAllUsers()).filter(user => user.role === 'doctor');
        const doctorSelector = document.getElementById('doctor');
        doctors.forEach(doctor => {
            const option = document.createElement('option');
            option.value = doctor.id;
            option.textContent = `${doctor.firstName} ${doctor.lastName}`;
            doctorSelector.appendChild(option);
        });
        doctorSelector.addEventListener('change', () => updateDepartments());
        updateDepartments();
    })();

    async function updateDepartments() {
        const doctorId = document.getElementById('doctor').value;
        if (doctorId == null) return;
        const doctor = (await getAllUsers()).filter(user => user.id === doctorId)[0];
        if (doctor == null) return;
        const departmentSelector = document.getElementById('department');
        departmentSelector.innerHTML = '';
        doctor.expertises.forEach(department => {
            const option = document.createElement('option');
            option.value = department.name;
            option.textContent = department.name;
            departmentSelector.appendChild(option);
        });
    }

    document.getElementById('appointment-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const doctor = document.getElementById('doctor').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const duration = document.getElementById('duration').value;
        const note = document.getElementById('note').value;
        const department = document.getElementById('department').value;

        try {
            await createAppointment({
                "doctorId": doctor,
                "dateTime": new Date(date + 'T' + time + 'Z').toISOString(),
                "department": department,
                "notes": note,
                "duration": duration + "m"
            });
            redirectTo('/patient-dashboard');
        } catch (error) {
            alert('Appointment failed: ' + error.message);
        }
    });
</script>